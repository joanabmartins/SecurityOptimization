{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "DeploySecurityCenterStandard": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Do you want to enable Security Center Standard?"
            }
        },
        "DeploySentinel": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Do you want to deploy Azure Sentinel?"
            }
        },
        "AssignPolicies": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Do you want to assign policies that will enable automatically log collection of key vault, app gw, nsg, and azure firewall?"
            }
        },
        "DeployWorkbook": {
            "type": "string",
            "defaultValue": "Yes",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "metadata": {
                "description": "Do you want to deploy our workbook?"
            }
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the new or existing log analytics workspace where you want to send ASC and diagnostic logs"
            }
        },
        "rgName": {
            "type": "string"
        },
        "automationAccountName": {
            "type": "string",
            "metadata": {
                "description": "Name for the new or existing automation account to store ASC secure score"
            }
        },
        "location": {
            "type": "String",
            "allowedValues": [
                "australiacentral",
                "australiaeast",
                "australiasoutheast",
                "brazilsouth",
                "canadacentral",
                "centralindia",
                "centralus",
                "eastasia",
                "eastus",
                "eastus2",
                "francecentral",
                "japaneast",
                "koreacentral",
                "northcentralus",
                "northeurope",
                "southafricanorth",
                "southcentralus",
                "southeastasia",
                "uksouth",
                "ukwest",
                "westcentralus",
                "westeurope",
                "westus",
                "westus2"
            ],
            "metadata": {
                "description": "Specifies the location in which to create the workspace."
            }
        },
        "emailForNotifications": {
            "type": "string",
            "metadata": {
                "description": "Email of the administrator who should be notified about Azure Security Center alert"
            }
        },
        "ascOwnerContact": {
            "type": "string",
            "metadata": {
                "description": "Phone number of the administrator should be notified about Azure Security Center alert"
            }
        },
        "LogicAppName": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "Sentinel-SendEmail-LogicApp"
        }
    },

    "variables": {},
    "resources": [

        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "AKVSolution",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/AKVSolution.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "AntimalwareSol",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/AntimalwareAssessmentSolution.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "AppGwSol",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/AppGwSolution.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('DeployWorkbook'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "[parameters('automationAccountName')]",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/AutomationAccount.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" },
                    "automationAccountName": { "value": "[parameters('automationAccountName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('DeployWorkbook'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "changeTraSol",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/ChangeTracking.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "[parameters('workspaceName')]",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/LogAnalyticsWorkspace.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" },
                    "location": { "value": "[parameters('location')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "NSGSol",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/NSGSolution.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policyAKVlogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeployDiagAKVLogs.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policyAppGwLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeployDiagAppGwLogs.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "PolicyAzFwLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeployDiagAzFwLogs.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicies'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policyNSGLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeployDiagNSGLogs.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "[parameters('rgName')]",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/ResourceGroup.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "rgName": { "value": "[parameters('rgName')]" },
                    "location": { "value": "[parameters('location')]" }
                }
            }
        },

        {
            "condition": "[equals(parameters('DeploySecurityCenterStandard'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "ASCStd",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/SecurityCenterSTD.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" },
                    "emailForNotifications": { "value": "[parameters('emailForNotifications')]" },
                    "ascOwnerContact": { "value": "[parameters('ascOwnerContact')]" },
                    "rgName": { "value": "[parameters('rgName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('DeploySentinel'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "SentinelPlaybook",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/SendEmailSentinelPlaybook.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "LogicAppName": { "value": "[parameters('LogicAppName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('DeploySentinel'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "Sentinel",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/SentinelSolution.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "Syslog",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/SyslogColl.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" },
                    "location": { "value": "[parameters('location')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('DeploySentinel'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "UpdateSol",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]",
                "[parameters('workspaceName')]",
                "[parameters('automationAccountName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/UpdateManagementSol.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" },
                    "automationAccountName": { "value": "[parameters('automationAccountName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('DeployWorkbook'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "Workbook",
            "resourceGroup": "[parameters('rgName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/Workbook.json",
                    "contentVersion": "1.0.0.0"
                }
            }
        }
    ],
    "outputs": {
    }
}
