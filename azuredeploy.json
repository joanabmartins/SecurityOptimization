{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "AssignPolicyToEnableDiagnosticLogs": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Collect logs for your logic apps, service bus, event hub, and key vault"
            }
        },
        "AssignPolicyToInstallQualysVAExtension": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Install Qualys Vulnerability assessment soluiton on your VMs - You need to have Azure Defender!"
            }
        },
        "AssignPolicyToEnforceHttpsAccess": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Enforce https access in web apps"
            }
        },
        "AssignPolicyToEnforceSecureAccess": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Enforce secure transfer required for your storage accounts"
            }
        },
        "AssignPolicyToEnforceAzureSqlAuditing": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "Enable auditing in Azure SQL"
            }
        },
        "resourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Name of the new or existing RG to deploy the log analytics and storage account."
            }
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the new or existing log analytics workspace where you want to send ASC and diagnostic logs"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "westeurope",
            "allowedValues": [
                "australiacentral",
                "australiaeast",
                "australiasoutheast",
                "brazilsouth",
                "canadacentral",
                "centralindia",
                "centralus",
                "eastasia",
                "eastus",
                "eastus2",
                "francecentral",
                "japaneast",
                "koreacentral",
                "northcentralus",
                "northeurope",
                "southafricanorth",
                "southcentralus",
                "southeastasia",
                "uksouth",
                "ukwest",
                "westcentralus",
                "westeurope",
                "westus",
                "westus2"
            ],
            "metadata": {
                "description": "Specifies the location in which to create the workspace."
            }
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "[parameters('workspaceName')]",
            "resourceGroup": "[parameters('resourceGroupName')]",
            "dependson": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', parameters('resourceGroupName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/LogAnalyticsWorkspace.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" },
                    "location": { "value": "[parameters('location')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicyToInstallQualysVAExtension'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policylogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeployQualys.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicyToEnableDiagnosticLogs'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policylogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeployDiagLogs.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": { "value": "[parameters('workspaceName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicyToEnforceHttpsAccess'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policyAppGwLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyAppHttpsAccess.json",
                    "contentVersion": "1.0.0.0"
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicyToEnforceSecureAccess'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "policyAppGwLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicySASecureTransfer.json",
                    "contentVersion": "1.0.0.0"
                }
        }
    },
        {
            "condition": "[equals(parameters('AssignPolicyToEnforceAzureSqlAuditing'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "PolicyAzFwLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeploySQLAuditing.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "resourceGroupName": { "value": "[parameters('resourceGroupName')]" }
                }
            }
        },
        {
            "condition": "[equals(parameters('AssignPolicyToEnforceAzureSqlAuditing'),'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "PolicyAzFwLogs",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/PolicyDeploySQLAuditing.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "resourceGroupName": { "value": "[parameters('resourceGroupName')]" }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "[parameters('resourceGroupName')]",
            "location": "[parameters('location')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/joanabmartins/SecurityOptimization/master/Templates/ResourceGroup.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "resourceGroupName": { "value": "[parameters('resourceGroupName')]" },
                    "location": { "value": "[parameters('location')]" }
                }
            }
        }
    ],
    "outputs": {
    }
}